<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bản đồ trạm sạc</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>#map{height:80vh;margin:8px}body{font-family:Arial,Helvetica,sans-serif}</style>
</head>
<body>
  <h2>Danh sách trạm sạc</h2>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const API_BASE = "http://localhost:3000";

    // Map trung tâm VN
    const map = L.map('map').setView([14.0583, 108.2772], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Debug: show API response
    function debugLog(...args){ console.log(...args); }

    // Lấy tất cả trạm → tạo marker
    fetch(`${API_BASE}/stations`)
      .then(r => r.json())
      .then(stations => {
        debugLog("stations:", stations);
        if (!Array.isArray(stations) || stations.length === 0) {
          alert("Không có trạm nào trong DB.");
          return;
        }
        const bounds = [];
        stations.forEach(st => {
          // marker
          const marker = L.marker([Number(st.latitude), Number(st.longitude)]).addTo(map);

          // bind click để load chi tiết từng station (chargers -> connectors)
          marker.on('click', () => {
            fetch(`${API_BASE}/stations/${st.id}`)
              .then(r => r.json())
              .then(detail => {
                debugLog("station detail:", detail);
                let html = `<div style="min-width:260px"><b>${detail.name}</b><br>📍 ${detail.address ?? ''}<br>🕒 ${detail.open_hours ?? ''}<br><hr>`;
                if (detail.chargers && detail.chargers.length) {
                  detail.chargers.forEach(ch => {
                    html += `<strong>${ch.name ?? 'Trụ'}</strong> — ${ch.power_kw??'N/A'} kW — <span style="color:${ch.status==='available'?'green':'red'}">${ch.status}</span><br>`;
                    if (ch.connectors && ch.connectors.length) {
                      html += `<ul style="margin:6px 0 6px 18px;padding:0">`;
                      ch.connectors.forEach(co => {
                        html += `<li>${co.type} — ${co.price_per_kwh ?? 'N/A'} đ/kWh — <span style="color:${co.status==='available'?'green':'red'}">${co.status}</span></li>`;
                      });
                      html += `</ul>`;
                    } else {
                      html += `<em>Chưa có cổng</em><br>`;
                    }
                  });
                } else {
                  html += `<em>Chưa có trụ sạc</em><br>`;
                }
                html += `<hr><button onclick="window.location.href='booking.html?station=${detail.id}'">Đặt chỗ</button></div>`;
                marker.bindPopup(html).openPopup();
              })
              .catch(err => {
                console.error("Lỗi lấy detail:", err);
                marker.bindPopup(`<b>${st.name}</b><br>Không thể tải chi tiết.`).openPopup();
              });
          });

          bounds.push([Number(st.latitude), Number(st.longitude)]);
        });

        if (bounds.length) map.fitBounds(bounds);
      })
      .catch(err => console.error("Lỗi lấy stations:", err));

  </script>
</body>
</html>
